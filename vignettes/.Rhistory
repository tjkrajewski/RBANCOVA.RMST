cont_unadj$adjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_lcl <- cont_unadj$adjusted.result["RMST (arm=1)-(arm=0)",3]
cont_u_lcl
cont_u_lcl <- cont_unadj$adjusted.result["RMST (arm=1)-(arm=0)",4]
cont_u_lcl
#Continuous Unadjusted
cont_u_est <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","Est."]
cont_u_lcl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_ucl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
cont_u_lcl
library(pseudo)
library(geepack)
library(survRM2)
#Continuous results
#Unadjusted
cont_unadj <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10)
#Tian
cont_tian <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10, covariates = pbc_filtered[,c("stage","copper_imp", "bili", "albumin")])
#Andersen
pseudo <- pseudomean(time = pbc_filtered$time_yea, event = pbc_filtered$status_dichot, tmax = 10)
fit_pv <- geeglm(pseudo ~ as.factor(arm)+as.factor(stage)+copper_imp+bili+albumin, id = seq_len(nrow(pbc_filtered)),
family = gaussian, corstr = "independence", data = pbc_filtered)
summary(fit_pv)  # coef on arm = covariate-adjusted ΔRMST(τ)
#Gather results with CIs from all methods
#RBANCOVA
#Continuous Unadjusted
cont_u_est <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","Est."]
cont_u_lcl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_ucl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Tian
tian_est <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","Est."]
tian_lcl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
tian_ucl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Anderesen
alpha <- 0.05
z <- qnorm(1 - alpha/2)
andersen_est <- fit_pv$coefficients["as.factor(arm)1"]
gee_se <- sqrt(diag(vcov(fit_pv))["as.factor(arm)1"])
andersen_lcl <- andersen_est - z*gee_se
andersen_ucl <- andersen_est + z*gee_se
# Build a long tidy frame (order the methods as you prefer)
df_methods <- tibble(
Method    = factor(c("Continuous Unadjusted", "Tian (Adjusted)", "Andersen (Pseudo-value)"),
levels = c("Andersen (Pseudo-value)", "Tian (Adjusted)", "Continuous Unadjusted")),
Estimate  = c(cont_u_est, tian_est, andersen_est),
Lower_CI  = c(cont_u_lcl, tian_lcl, andersen_lcl),
Upper_CI  = c(cont_u_ucl, tian_ucl, andersen_ucl)
) %>%
mutate(Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI))
## --- 2) Plot: horizontal CIs (methods on the y-axis) ----------------------
ggplot(df_methods, aes(x = Method, y = Estimate)) +
geom_point(size = 4) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.15, size = 1) +
coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed") +   # null line at 0
theme_minimal(base_size = 14) +
labs(title = "RMST Difference (Treated − Control) at τ",
x = NULL,
y = "RMST Difference (years)") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
axis.title.y = element_blank(),
legend.position = "none",
plot.margin = margin(5, 20, 5, 5)
) +
# Show the estimate (95% CI) to the right of each point
geom_text(aes(label = Estimate_CI), hjust = -0.1, size = 4) +
# Add a bit of right-side space for the labels
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))
df_methods
ggplot(df_methods, aes(x = Method, y = Estimate)) +
geom_point(size = 4) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.15, size = 1) +
coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed") +   # null line at 0
theme_minimal(base_size = 14) +
labs(title = "RMST Difference (Treated − Control) at τ",
x = NULL,
y = "RMST Difference (years)") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
axis.title.y = element_blank(),
legend.position = "none",
plot.margin = margin(5, 20, 5, 5)
) +
# Show the estimate (95% CI) to the right of each point
geom_text(aes(label = Estimate_CI), hjust = -0.1, size = 4) +
# Add a bit of right-side space for the labels
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))
library(pseudo)
library(geepack)
library(survRM2)
#Continuous results
#Unadjusted
cont_unadj <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10)
#Tian
cont_tian <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10, covariates = pbc_filtered[,c("stage","copper_imp", "bili", "albumin")])
#Andersen
pseudo <- pseudomean(time = pbc_filtered$time_yea, event = pbc_filtered$status_dichot, tmax = 10)
fit_pv <- geeglm(pseudo ~ as.factor(arm)+as.factor(stage)+copper_imp+bili+albumin, id = seq_len(nrow(pbc_filtered)),
family = gaussian, corstr = "independence", data = pbc_filtered)
summary(fit_pv)  # coef on arm = covariate-adjusted ΔRMST(τ)
#Gather results with CIs from all methods
#RBANCOVA
#Continuous Unadjusted
cont_u_est <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","Est."]
cont_u_lcl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_ucl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Tian
tian_est <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","Est."]
tian_lcl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
tian_ucl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Anderesen
alpha <- 0.05
z <- qnorm(1 - alpha/2)
andersen_est <- fit_pv$coefficients["as.factor(arm)1"]
gee_se <- sqrt(diag(vcov(fit_pv))["as.factor(arm)1"])
andersen_lcl <- andersen_est - z*gee_se
andersen_ucl <- andersen_est + z*gee_se
#--- helpers ---------------------------------------------------------------
.get_tbl <- function(x) if (!is.null(x$table_pretty)) x$table_pretty else x
.parse_estCI <- function(s) {
m <- str_match(s, "([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\(\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*,\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\)")
c(est = as.numeric(m[2]), lcl = as.numeric(m[3]), ucl = as.numeric(m[4]))
}
#--- (1) Build df of all methods ---------------
df_methods <- tibble(
Method    = factor(c("Continuous Unadjusted", "Tian (Adjusted)", "Andersen (Pseudo-value)"),
levels = c("Andersen (Pseudo-value)", "Tian (Adjusted)", "Continuous Unadjusted")),
Estimate  = c(cont_u_est, tian_est, andersen_est),
Lower_CI  = c(cont_u_lcl, tian_lcl, andersen_lcl),
Upper_CI  = c(cont_u_ucl, tian_ucl, andersen_ucl)
) %>%
mutate(Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI))
#--- (2) Add RB-ANCOVA unadjusted & adjusted contrasts ---------------------
rb_tbl <- .get_tbl(results_1time)
rb_u  <- rb_tbl %>% filter(method == "unadjusted",
contrast == "Treated - Control") %>% slice(1)
rb_a  <- rb_tbl %>% filter(method == "covariate-adjusted",
contrast == "Treated - Control") %>% slice(1)
u_vals <- .parse_estCI(rb_u$est_CI)
a_vals <- .parse_estCI(rb_a$est_CI)
rb_df <- tibble(
Method   = c("RB-ANCOVA (Unadjusted)", "RB-ANCOVA (Adjusted)"),
Estimate = c(u_vals["est"], a_vals["est"]),
Lower_CI = c(u_vals["lcl"], a_vals["lcl"]),
Upper_CI = c(u_vals["ucl"], a_vals["ucl"])
)
#--- (3) Combine & order methods -------------------------------------------
plot_df <- bind_rows(df_methods, rb_df) %>%
mutate(
Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI),
Method = factor(
Method,
levels = c("RB-ANCOVA (Adjusted)", "RB-ANCOVA (Unadjusted)",
"Andersen (Pseudo-value)", "Tian (Adjusted)",
"Continuous Unadjusted")
)
)
#--- (4) Plot: horizontal CIs (one line per method) ------------------------
ggplot(plot_df, aes(x = Method, y = Estimate)) +
geom_point(size = 4) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.15, size = 1) +
coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed") +
theme_minimal(base_size = 14) +
labs(title = "RMST Difference (Treated − Control) at τ",
x = NULL, y = "RMST Difference (years)") +
theme(plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "none",
plot.margin = margin(5, 20, 5, 5)) +
geom_text(aes(label = Estimate_CI), hjust = -0.1, size = 4) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))
#--- (4) Plot: horizontal CIs (one line per method) ------------------------
ggplot(plot_df, aes(x = Method, y = Estimate)) +
geom_point(size = 4) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI), width = 0.15, size = 1) +
coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed") +
theme_minimal(base_size = 14) +
labs(title = "RMST Difference (Treated − Control) at τ",
x = NULL, y = "RMST Difference (years)") +
theme(plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "none",
plot.margin = margin(5, 20, 5, 5)) +
geom_text(aes(label = Estimate_CI), hjust = -0.1, size = 4) +
scale_y_continuous(expand = expansion(mult = c(0.05, 0.15)))
# Collapse method names to two color groups
plot_df2 <- plot_df %>%
mutate(
Estimator = ifelse(grepl("unadjusted", Method, ignore.case = TRUE),
"Unadjusted", "Adjusted"),
Estimator = factor(Estimator, levels = c("Unadjusted", "Adjusted")),
Method = factor(Method, levels = levels(plot_df$Method)) # keep your chosen order
)
pos <- position_dodge(width = 0.6)
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at \u03C4",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
geom_hline(yintercept = 0, linetype = "dashed") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
#geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
library(pseudo)
library(geepack)
library(survRM2)
#Continuous results
#Unadjusted
cont_unadj <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10)
#Tian
cont_tian <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10, covariates = pbc_filtered[,c("stage","copper_imp", "bili", "albumin")])
#Andersen
pseudo <- pseudomean(time = pbc_filtered$time_yea, event = pbc_filtered$status_dichot, tmax = 10)
fit_pv <- geeglm(pseudo ~ as.factor(arm)+as.factor(stage)+copper_imp+bili+albumin, id = seq_len(nrow(pbc_filtered)),
family = gaussian, corstr = "independence", data = pbc_filtered)
summary(fit_pv)  # coef on arm = covariate-adjusted ΔRMST(τ)
#Gather results with CIs from all methods
#RBANCOVA
#Continuous Unadjusted
cont_u_est <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","Est."]
cont_u_lcl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_ucl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Tian
tian_est <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","Est."]
tian_lcl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
tian_ucl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Anderesen
alpha <- 0.05
z <- qnorm(1 - alpha/2)
andersen_est <- fit_pv$coefficients["as.factor(arm)1"]
gee_se <- sqrt(diag(vcov(fit_pv))["as.factor(arm)1"])
andersen_lcl <- andersen_est - z*gee_se
andersen_ucl <- andersen_est + z*gee_se
#--- helpers ---------------------------------------------------------------
.get_tbl <- function(x) if (!is.null(x$table_pretty)) x$table_pretty else x
.parse_estCI <- function(s) {
m <- str_match(s, "([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\(\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*,\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\)")
c(est = as.numeric(m[2]), lcl = as.numeric(m[3]), ucl = as.numeric(m[4]))
}
#--- (1) Build df of all methods ---------------
df_methods <- tibble(
Method    = factor(c("Continuous-Unadjusted", "Continuous-Tian", "Continuous-Andersen"),
levels = c("Continuous-Unadjusted", "Continuous-Tian", "Continuous-Andersen")),
Estimate  = c(cont_u_est, tian_est, andersen_est),
Lower_CI  = c(cont_u_lcl, tian_lcl, andersen_lcl),
Upper_CI  = c(cont_u_ucl, tian_ucl, andersen_ucl)
) %>%
mutate(Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI))
#--- (2) Add RB-ANCOVA unadjusted & adjusted contrasts ---------------------
rb_tbl <- .get_tbl(results_1time)
rb_u  <- rb_tbl %>% filter(method == "unadjusted",
contrast == "Treated - Control") %>% slice(1)
rb_a  <- rb_tbl %>% filter(method == "covariate-adjusted",
contrast == "Treated - Control") %>% slice(1)
u_vals <- .parse_estCI(rb_u$est_CI)
a_vals <- .parse_estCI(rb_a$est_CI)
rb_df <- tibble(
Method   = c("Unadjusted", "RB-ANCOVA"),
Estimate = c(u_vals["est"], a_vals["est"]),
Lower_CI = c(u_vals["lcl"], a_vals["lcl"]),
Upper_CI = c(u_vals["ucl"], a_vals["ucl"])
)
#--- (3) Combine & order methods -------------------------------------------
plot_df <- bind_rows(df_methods, rb_df) %>%
mutate(
Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI),
Method = factor(
Method,
levels = c("Unadjusted", "Continuous-Unadjusted", "RB-ANCOVA",
"Continuous-Tian", "Continuous-Andersen")
)
)
# Collapse method names to two color groups
plot_df2 <- plot_df %>%
mutate(
Estimator = ifelse(grepl("unadjusted", Method, ignore.case = TRUE),
"Unadjusted", "Adjusted"),
Estimator = factor(Estimator, levels = c("Unadjusted", "Adjusted")),
Method = factor(Method, levels = levels(plot_df$Method)) # keep your chosen order
)
pos <- position_dodge(width = 0.6)
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
#geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
#geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
library(pseudo)
library(geepack)
library(survRM2)
#Continuous results
#Unadjusted
cont_unadj <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10)
#Tian
cont_tian <- rmst2(pbc_filtered$time_year, pbc_filtered$status_dichot, pbc_filtered$arm, tau=10, covariates = pbc_filtered[,c("stage","copper_imp", "bili", "albumin")])
#Andersen
pseudo <- pseudomean(time = pbc_filtered$time_yea, event = pbc_filtered$status_dichot, tmax = 10)
fit_pv <- geeglm(pseudo ~ as.factor(arm)+as.factor(stage)+copper_imp+bili+albumin, id = seq_len(nrow(pbc_filtered)),
family = gaussian, corstr = "independence", data = pbc_filtered)
summary(fit_pv)  # coef on arm = covariate-adjusted ΔRMST(τ)
#Gather results with CIs from all methods
#RBANCOVA
#Continuous Unadjusted
cont_u_est <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","Est."]
cont_u_lcl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
cont_u_ucl <- cont_unadj$unadjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Tian
tian_est <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","Est."]
tian_lcl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","lower .95"]
tian_ucl <- cont_tian$adjusted.result["RMST (arm=1)-(arm=0)","upper .95"]
#Anderesen
alpha <- 0.05
z <- qnorm(1 - alpha/2)
andersen_est <- fit_pv$coefficients["as.factor(arm)1"]
gee_se <- sqrt(diag(vcov(fit_pv))["as.factor(arm)1"])
andersen_lcl <- andersen_est - z*gee_se
andersen_ucl <- andersen_est + z*gee_se
#--- helpers ---------------------------------------------------------------
.get_tbl <- function(x) if (!is.null(x$table_pretty)) x$table_pretty else x
.parse_estCI <- function(s) {
m <- str_match(s, "([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\(\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*,\\s*([-+]?\\d*\\.?\\d+(?:[eE][-+]?\\d+)?)\\s*\\)")
c(est = as.numeric(m[2]), lcl = as.numeric(m[3]), ucl = as.numeric(m[4]))
}
#--- (1) Build df of all methods ---------------
df_methods <- tibble(
Method    = factor(c("Continuous-Unadjusted", "Continuous-Tian", "Continuous-Andersen"),
levels = c("Continuous-Unadjusted", "Continuous-Tian", "Continuous-Andersen")),
Estimate  = c(cont_u_est, tian_est, andersen_est),
Lower_CI  = c(cont_u_lcl, tian_lcl, andersen_lcl),
Upper_CI  = c(cont_u_ucl, tian_ucl, andersen_ucl)
) %>%
mutate(Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI))
#--- (2) Add RB-ANCOVA unadjusted & adjusted contrasts ---------------------
rb_tbl <- .get_tbl(results_1time)
rb_u  <- rb_tbl %>% filter(method == "unadjusted",
contrast == "Treated - Control") %>% slice(1)
rb_a  <- rb_tbl %>% filter(method == "covariate-adjusted",
contrast == "Treated - Control") %>% slice(1)
u_vals <- .parse_estCI(rb_u$est_CI)
a_vals <- .parse_estCI(rb_a$est_CI)
rb_df <- tibble(
Method   = c("Unadjusted", "RB-ANCOVA"),
Estimate = c(u_vals["est"], a_vals["est"]),
Lower_CI = c(u_vals["lcl"], a_vals["lcl"]),
Upper_CI = c(u_vals["ucl"], a_vals["ucl"])
)
#--- (3) Combine & order methods -------------------------------------------
plot_df <- bind_rows(df_methods, rb_df) %>%
mutate(
Estimate_CI = sprintf("%.2f (%.2f, %.2f)", Estimate, Lower_CI, Upper_CI),
Method = factor(
Method,
levels = c("Continuous-Andersen", "Continuous-Tian", "RB-ANCOVA", "Continuous-Unadjusted", "Unadjusted")
)
)
# Collapse method names to two color groups
plot_df2 <- plot_df %>%
mutate(
Estimator = ifelse(grepl("unadjusted", Method, ignore.case = TRUE),
"Unadjusted", "Adjusted"),
Estimator = factor(Estimator, levels = c("Unadjusted", "Adjusted")),
Method = factor(Method, levels = levels(plot_df$Method)) # keep your chosen order
)
pos <- position_dodge(width = 0.6)
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
#geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
ggplot(plot_df2, aes(x = Method, y = Estimate, color = Estimator)) +
geom_point(size = 4, shape = 16, position = pos) +
geom_errorbar(aes(ymin = Lower_CI, ymax = Upper_CI),
width = 0.2, position = pos, size = 1) +
coord_flip() +
scale_color_manual(values = c("Adjusted" = "blue", "Unadjusted" = "black")) +
theme_minimal(base_size = 14) +
labs(title = "Restricted Mean Survival Time Difference at 10 Years",
x = NULL,
y = "RMST Difference (Years)",
color = "Estimator") +
theme(
plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
axis.title = element_text(size = 14, face = "bold"),
axis.text = element_text(size = 12),
legend.position = "top",
plot.margin = margin(5, 20, 5, 5)
) +
#geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
# Label next to each point, matching line color
geom_text(aes(label = Estimate_CI, color = Estimator),
position = pos, vjust = 2, size = 4, hjust = 0.5, show.legend = FALSE) +
scale_y_continuous(expand = expansion(mult = c(0.2, 0.1)))
